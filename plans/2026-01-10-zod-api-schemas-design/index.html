<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Modern web application for browsing and streaming your Stash media library"><meta name=author content=carrotwaxr><link href=https://carrotwaxr.github.io/peek-stash-browser/plans/2026-01-10-zod-api-schemas-design/ rel=canonical><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.2"><title>Zod API Schemas for Peek - Peek Stash Browser</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=pink> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#zod-api-schemas-for-peek class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Peek Stash Browser" class="md-header__button md-logo" aria-label="Peek Stash Browser" data-md-component=logo> <img src=../../assets/peek-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Peek Stash Browser </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Zod API Schemas for Peek </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=pink aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=pink aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/carrotwaxr/peek-stash-browser title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> carrotwaxr/peek-stash-browser </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Peek Stash Browser" class="md-nav__button md-logo" aria-label="Peek Stash Browser" data-md-component=logo> <img src=../../assets/peek-logo.png alt=logo> </a> Peek Stash Browser </label> <div class=md-nav__source> <a href=https://github.com/carrotwaxr/peek-stash-browser title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> carrotwaxr/peek-stash-browser </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/upgrading/ class=md-nav__link> <span class=md-ellipsis> Upgrading </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/browse-and-display/ class=md-nav__link> <span class=md-ellipsis> Browse and Display </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/content-restrictions/ class=md-nav__link> <span class=md-ellipsis> Content Restrictions </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/custom-carousels/ class=md-nav__link> <span class=md-ellipsis> Custom Carousels </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/downloads/ class=md-nav__link> <span class=md-ellipsis> Downloads </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/external-player/ class=md-nav__link> <span class=md-ellipsis> External Player </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/hidden-items/ class=md-nav__link> <span class=md-ellipsis> Hidden Items </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/images/ class=md-nav__link> <span class=md-ellipsis> Images </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/keyboard-navigation/ class=md-nav__link> <span class=md-ellipsis> Keyboard Navigation </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/merge-detection/ class=md-nav__link> <span class=md-ellipsis> Merge Detection </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/personalization/ class=md-nav__link> <span class=md-ellipsis> Personalization </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/playlists/ class=md-nav__link> <span class=md-ellipsis> Playlists </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/recommendations/ class=md-nav__link> <span class=md-ellipsis> Recommendations </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/user-management/ class=md-nav__link> <span class=md-ellipsis> User Management </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/watch-history/ class=md-nav__link> <span class=md-ellipsis> Watch History </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/docker-basics/ class=md-nav__link> <span class=md-ellipsis> Docker Basics </span> </a> </li> <li class=md-nav__item> <a href=../../reference/api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> <li class=md-nav__item> <a href=../../reference/entity-relationships/ class=md-nav__link> <span class=md-ellipsis> Entity Relationships </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/local-setup/ class=md-nav__link> <span class=md-ellipsis> Local Setup </span> </a> </li> <li class=md-nav__item> <a href=../../development/technical-overview/ class=md-nav__link> <span class=md-ellipsis> Technical Overview </span> </a> </li> <li class=md-nav__item> <a href=../../development/sync-architecture/ class=md-nav__link> <span class=md-ellipsis> Sync Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../development/regression-testing/ class=md-nav__link> <span class=md-ellipsis> Regression Testing Guide </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#goals class=md-nav__link> <span class=md-ellipsis> Goals </span> </a> </li> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> <span class=md-ellipsis> Prerequisites </span> </a> </li> <li class=md-nav__item> <a href=#architecture class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class=md-nav__item> <a href=#design-principles class=md-nav__link> <span class=md-ellipsis> Design Principles </span> </a> <nav class=md-nav aria-label="Design Principles"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-schemas-are-composable class=md-nav__link> <span class=md-ellipsis> 1. Schemas Are Composable </span> </a> </li> <li class=md-nav__item> <a href=#2-response-types-compose-fragments class=md-nav__link> <span class=md-ellipsis> 2. Response Types Compose Fragments </span> </a> </li> <li class=md-nav__item> <a href=#3-derive-typescript-types-from-schemas class=md-nav__link> <span class=md-ellipsis> 3. Derive TypeScript Types from Schemas </span> </a> </li> <li class=md-nav__item> <a href=#4-validate-at-api-boundary class=md-nav__link> <span class=md-ellipsis> 4. Validate at API Boundary </span> </a> </li> <li class=md-nav__item> <a href=#5-use-strip-for-safety class=md-nav__link> <span class=md-ellipsis> 5. Use .strip() for Safety </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schema-organization class=md-nav__link> <span class=md-ellipsis> Schema Organization </span> </a> </li> <li class=md-nav__item> <a href=#proposed-schemas class=md-nav__link> <span class=md-ellipsis> Proposed Schemas </span> </a> <nav class=md-nav aria-label="Proposed Schemas"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#base-schemas class=md-nav__link> <span class=md-ellipsis> Base Schemas </span> </a> </li> <li class=md-nav__item> <a href=#reference-schemas class=md-nav__link> <span class=md-ellipsis> Reference Schemas </span> </a> </li> <li class=md-nav__item> <a href=#scene-schemas class=md-nav__link> <span class=md-ellipsis> Scene Schemas </span> </a> </li> <li class=md-nav__item> <a href=#performer-schemas class=md-nav__link> <span class=md-ellipsis> Performer Schemas </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#migration-strategy class=md-nav__link> <span class=md-ellipsis> Migration Strategy </span> </a> <nav class=md-nav aria-label="Migration Strategy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#approach-incremental-endpoint-by-endpoint class=md-nav__link> <span class=md-ellipsis> Approach: Incremental, Endpoint by Endpoint </span> </a> </li> <li class=md-nav__item> <a href=#example-migration class=md-nav__link> <span class=md-ellipsis> Example Migration </span> </a> </li> <li class=md-nav__item> <a href=#helper-transform-functions class=md-nav__link> <span class=md-ellipsis> Helper: Transform Functions </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#endpoint-priority class=md-nav__link> <span class=md-ellipsis> Endpoint Priority </span> </a> </li> <li class=md-nav__item> <a href=#testing class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> <nav class=md-nav aria-label=Testing> <ul class=md-nav__list> <li class=md-nav__item> <a href=#unit-tests-for-schemas class=md-nav__link> <span class=md-ellipsis> Unit Tests for Schemas </span> </a> </li> <li class=md-nav__item> <a href=#integration-tests class=md-nav__link> <span class=md-ellipsis> Integration Tests </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dependencies class=md-nav__link> <span class=md-ellipsis> Dependencies </span> </a> </li> <li class=md-nav__item> <a href=#success-criteria class=md-nav__link> <span class=md-ellipsis> Success Criteria </span> </a> </li> <li class=md-nav__item> <a href=#future-considerations class=md-nav__link> <span class=md-ellipsis> Future Considerations </span> </a> <nav class=md-nav aria-label="Future Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#client-side-validation class=md-nav__link> <span class=md-ellipsis> Client-Side Validation </span> </a> </li> <li class=md-nav__item> <a href=#openapi-generation class=md-nav__link> <span class=md-ellipsis> OpenAPI Generation </span> </a> </li> <li class=md-nav__item> <a href=#error-messages class=md-nav__link> <span class=md-ellipsis> Error Messages </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=zod-api-schemas-for-peek>Zod API Schemas for Peek<a class=headerlink href=#zod-api-schemas-for-peek title="Permanent link">&para;</a></h1> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>Introduce Zod schemas as the source of truth for Peek's API responses. This creates predictable, composable type fragments derived from what we actually expose to clients, rather than inheriting bloated types from Stash.</p> <h2 id=goals>Goals<a class=headerlink href=#goals title="Permanent link">&para;</a></h2> <ol> <li><strong>Predictable API responses</strong>: Define exactly what shape leaves the server</li> <li><strong>Composable fragments</strong>: Build complex types from reusable pieces</li> <li><strong>Decouple from Stash types</strong>: API types derived from our needs, not Stash's schema</li> <li><strong>Runtime validation</strong>: Catch transformation bugs before clients see malformed data</li> <li><strong>Single source of truth</strong>: Zod schemas define both runtime validation and TypeScript types</li> </ol> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h2> <p>Complete Phase 1 first: <a href=../2026-01-10-remove-stashapp-api-design/ >2026-01-10-remove-stashapp-api-design.md</a></p> <p>After Phase 1: - Stash types are only used at sync boundary - Prisma types are used for internal DB operations - API response types are currently <code>NormalizedXxx</code> (extending old Stash types)</p> <h2 id=architecture>Architecture<a class=headerlink href=#architecture title="Permanent link">&para;</a></h2> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>┌─────────────────────────────────────────────────────────────────┐
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>│                        Peek Server                               │
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>├─────────────────────────────────────────────────────────────────┤
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>│                                                                   │
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>│  Stash GraphQL ──► Sync Types ──► Prisma/SQLite                  │
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>│  (generated)       (internal)      (storage)                     │
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>│                                                                   │
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>│                                        │                          │
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>│                                        ▼                          │
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>│                                   Zod Schemas ◄── Source of Truth │
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>│                                        │                          │
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>│                                        ▼                          │
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>│                                   API Responses                   │
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>│                                   (validated)                     │
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>│                                                                   │
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>└─────────────────────────────────────────────────────────────────┘
</span></code></pre></div> <h2 id=design-principles>Design Principles<a class=headerlink href=#design-principles title="Permanent link">&para;</a></h2> <h3 id=1-schemas-are-composable>1. Schemas Are Composable<a class=headerlink href=#1-schemas-are-composable title="Permanent link">&para;</a></h3> <p>Build from small, reusable fragments:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// Base reference types (id + display name)</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>const</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>  </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=p>});</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=kd>const</span><span class=w> </span><span class=nx>PerformerRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>  </span><span class=nx>gender</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=p>});</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=kd>const</span><span class=w> </span><span class=nx>StudioRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=p>});</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=kd>const</span><span class=w> </span><span class=nx>TagRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>;</span>
</span></code></pre></div> <h3 id=2-response-types-compose-fragments>2. Response Types Compose Fragments<a class=headerlink href=#2-response-types-compose-fragments title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1>// Card view - minimal data for grid/list display</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kd>const</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>  </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>  </span><span class=nx>date</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>  </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>  </span><span class=nx>rating100</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>  </span><span class=nx>pathScreenshot</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>  </span><span class=nx>studio</span><span class=o>:</span><span class=w> </span><span class=kt>StudioRefSchema.nullable</span><span class=p>(),</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>  </span><span class=nx>performers</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>PerformerRefSchema</span><span class=p>),</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=p>});</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=c1>// Detail view - extends card with additional fields</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=kd>const</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>  </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>  </span><span class=nx>director</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>  </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=w>  </span><span class=nx>tags</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>TagRefSchema</span><span class=p>),</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>  </span><span class=nx>files</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>FileInfoSchema</span><span class=p>),</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>  </span><span class=nx>paths</span><span class=o>:</span><span class=w> </span><span class=kt>ScenePathsSchema</span><span class=p>,</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>  </span><span class=c1>// User-specific data</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>  </span><span class=nx>userRating</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=w>  </span><span class=nx>playCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=w>  </span><span class=nx>isFavorite</span><span class=o>:</span><span class=w> </span><span class=kt>z.boolean</span><span class=p>(),</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=p>});</span>
</span></code></pre></div> <h3 id=3-derive-typescript-types-from-schemas>3. Derive TypeScript Types from Schemas<a class=headerlink href=#3-derive-typescript-types-from-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1>// Types are inferred, never manually defined</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>SceneCard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>SceneDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>PerformerRef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>PerformerRefSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span></code></pre></div> <h3 id=4-validate-at-api-boundary>4. Validate at API Boundary<a class=headerlink href=#4-validate-at-api-boundary title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1>// In controller/route handler</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>getScene</span><span class=p>(</span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=kt>Request</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=kt>Response</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>scene</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>sceneService</span><span class=p>.</span><span class=nx>getById</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=c1>// Validate before sending - catches bugs in our code</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>validated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>scene</span><span class=p>);</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>  </span><span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>validated</span><span class=p>);</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=p>}</span>
</span></code></pre></div> <h3 id=5-use-strip-for-safety>5. Use <code>.strip()</code> for Safety<a class=headerlink href=#5-use-strip-for-safety title="Permanent link">&para;</a></h3> <p>Zod's <code>.strip()</code> removes extra fields, ensuring we never accidentally leak internal data:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kd>const</span><span class=w> </span><span class=nx>SafeSceneSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=p>.</span><span class=nx>strip</span><span class=p>();</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1>// Even if scene object has extra fields, they won&#39;t be in response</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kd>const</span><span class=w> </span><span class=nx>validated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SafeSceneSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>scene</span><span class=p>);</span>
</span></code></pre></div> <h2 id=schema-organization>Schema Organization<a class=headerlink href=#schema-organization title="Permanent link">&para;</a></h2> <div class="language-text highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>server/src/schemas/
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>├── index.ts              # Re-exports all schemas
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>├── base.ts               # Primitive/shared schemas
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>├── refs.ts               # EntityRef schemas (id + name patterns)
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>├── scene.ts              # Scene-related schemas
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>├── performer.ts          # Performer-related schemas
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>├── studio.ts             # Studio-related schemas
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>├── tag.ts                # Tag-related schemas
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>├── gallery.ts            # Gallery-related schemas
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>├── group.ts              # Group-related schemas
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>├── image.ts              # Image-related schemas
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>├── user.ts               # User preference/data schemas
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>└── api/                  # Request/response schemas per endpoint
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>    ├── scenes.ts
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>    ├── performers.ts
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>    └── ...
</span></code></pre></div> <h2 id=proposed-schemas>Proposed Schemas<a class=headerlink href=#proposed-schemas title="Permanent link">&para;</a></h2> <h3 id=base-schemas>Base Schemas<a class=headerlink href=#base-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1>// server/src/schemas/base.ts</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>z</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>PaginationSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>  </span><span class=nx>page</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=kr>int</span><span class=p>().</span><span class=nx>positive</span><span class=p>(),</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>  </span><span class=nx>perPage</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=kr>int</span><span class=p>().</span><span class=nx>positive</span><span class=p>().</span><span class=nx>max</span><span class=p>(</span><span class=mf>100</span><span class=p>),</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>  </span><span class=nx>total</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=kr>int</span><span class=p>().</span><span class=nx>nonnegative</span><span class=p>(),</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>  </span><span class=nx>totalPages</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=kr>int</span><span class=p>().</span><span class=nx>nonnegative</span><span class=p>(),</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=p>});</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>DateStringSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=kt>string</span><span class=p>().</span><span class=nx>regex</span><span class=p>(</span><span class=sr>/^\d{4}-\d{2}-\d{2}$/</span><span class=p>);</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>TimestampSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=kt>string</span><span class=p>().</span><span class=nx>datetime</span><span class=p>();</span>
</span></code></pre></div> <h3 id=reference-schemas>Reference Schemas<a class=headerlink href=#reference-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1>// server/src/schemas/refs.ts</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>z</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=c1>// Minimal reference - just enough to link/display</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>  </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=p>});</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>PerformerRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>  </span><span class=nx>gender</span><span class=o>:</span><span class=w> </span><span class=kt>z.enum</span><span class=p>([</span><span class=s1>&#39;MALE&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;FEMALE&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;TRANSGENDER_MALE&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;TRANSGENDER_FEMALE&#39;</span><span class=p>,</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>                  </span><span class=s1>&#39;INTERSEX&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;NON_BINARY&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;OTHER&#39;</span><span class=p>]).</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=p>});</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>StudioRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=p>});</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>TagRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=p>});</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>GroupRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=w>  </span><span class=nx>frontImagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=p>});</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>GalleryRefSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>EntityRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=w>  </span><span class=nx>coverPath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=w>  </span><span class=nx>imageCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=p>});</span>
</span></code></pre></div> <h3 id=scene-schemas>Scene Schemas<a class=headerlink href=#scene-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1>// server/src/schemas/scene.ts</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>z</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PerformerRefSchema</span><span class=p>,</span><span class=w> </span><span class=nx>StudioRefSchema</span><span class=p>,</span><span class=w> </span><span class=nx>TagRefSchema</span><span class=p>,</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>         </span><span class=nx>GroupRefSchema</span><span class=p>,</span><span class=w> </span><span class=nx>GalleryRefSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./refs&#39;</span><span class=p>;</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>SceneFileSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>  </span><span class=nx>path</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>  </span><span class=nx>size</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>  </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=nx>width</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>  </span><span class=nx>height</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>  </span><span class=nx>bitRate</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>  </span><span class=nx>frameRate</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>  </span><span class=nx>videoCodec</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>  </span><span class=nx>audioCodec</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=p>});</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>ScenePathsSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>  </span><span class=nx>screenshot</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=w>  </span><span class=nx>preview</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>  </span><span class=nx>sprite</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=w>  </span><span class=nx>vtt</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=w>  </span><span class=nx>stream</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=p>});</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>SceneStreamsSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>array</span><span class=p>(</span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a><span class=w>  </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=w>  </span><span class=nx>mimeType</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=w>  </span><span class=nx>label</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a><span class=p>}));</span>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a><span class=c1>// Card view - for grids and lists</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a><span class=w>  </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=w>  </span><span class=nx>date</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a><span class=w>  </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a><span class=w>  </span><span class=nx>rating100</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a><span class=w>  </span><span class=nx>organized</span><span class=o>:</span><span class=w> </span><span class=kt>z.boolean</span><span class=p>(),</span>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a><span class=w>  </span><span class=nx>pathScreenshot</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a><span class=w>  </span><span class=nx>pathPreview</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a><span class=w>  </span><span class=nx>studio</span><span class=o>:</span><span class=w> </span><span class=kt>StudioRefSchema.nullable</span><span class=p>(),</span>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a><span class=w>  </span><span class=nx>performers</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>PerformerRefSchema</span><span class=p>),</span>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a><span class=w>  </span><span class=nx>tags</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>TagRefSchema</span><span class=p>),</span>
</span><span id=__span-9-45><a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a><span class=w>  </span><span class=c1>// User data</span>
</span><span id=__span-9-46><a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a><span class=w>  </span><span class=nx>userRating</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-47><a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a><span class=w>  </span><span class=nx>playCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-9-48><a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a><span class=w>  </span><span class=nx>isFavorite</span><span class=o>:</span><span class=w> </span><span class=kt>z.boolean</span><span class=p>(),</span>
</span><span id=__span-9-49><a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a><span class=w>  </span><span class=nx>lastPlayedAt</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-50><a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a><span class=p>});</span>
</span><span id=__span-9-51><a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a>
</span><span id=__span-9-52><a id=__codelineno-9-52 name=__codelineno-9-52 href=#__codelineno-9-52></a><span class=c1>// Detail view - full scene data</span>
</span><span id=__span-9-53><a id=__codelineno-9-53 name=__codelineno-9-53 href=#__codelineno-9-53></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-9-54><a id=__codelineno-9-54 name=__codelineno-9-54 href=#__codelineno-9-54></a><span class=w>  </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-55><a id=__codelineno-9-55 name=__codelineno-9-55 href=#__codelineno-9-55></a><span class=w>  </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-56><a id=__codelineno-9-56 name=__codelineno-9-56 href=#__codelineno-9-56></a><span class=w>  </span><span class=nx>director</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-9-57><a id=__codelineno-9-57 name=__codelineno-9-57 href=#__codelineno-9-57></a><span class=w>  </span><span class=nx>oCounter</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-9-58><a id=__codelineno-9-58 name=__codelineno-9-58 href=#__codelineno-9-58></a><span class=w>  </span><span class=nx>playDuration</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-9-59><a id=__codelineno-9-59 name=__codelineno-9-59 href=#__codelineno-9-59></a><span class=w>  </span><span class=nx>groups</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>GroupRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span><span class=w> </span><span class=nx>sceneIndex</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>()</span><span class=w> </span><span class=p>})),</span>
</span><span id=__span-9-60><a id=__codelineno-9-60 name=__codelineno-9-60 href=#__codelineno-9-60></a><span class=w>  </span><span class=nx>galleries</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>GalleryRefSchema</span><span class=p>),</span>
</span><span id=__span-9-61><a id=__codelineno-9-61 name=__codelineno-9-61 href=#__codelineno-9-61></a><span class=w>  </span><span class=nx>files</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>SceneFileSchema</span><span class=p>),</span>
</span><span id=__span-9-62><a id=__codelineno-9-62 name=__codelineno-9-62 href=#__codelineno-9-62></a><span class=w>  </span><span class=nx>paths</span><span class=o>:</span><span class=w> </span><span class=kt>ScenePathsSchema</span><span class=p>,</span>
</span><span id=__span-9-63><a id=__codelineno-9-63 name=__codelineno-9-63 href=#__codelineno-9-63></a><span class=w>  </span><span class=nx>streams</span><span class=o>:</span><span class=w> </span><span class=kt>SceneStreamsSchema</span><span class=p>,</span>
</span><span id=__span-9-64><a id=__codelineno-9-64 name=__codelineno-9-64 href=#__codelineno-9-64></a><span class=w>  </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-9-65><a id=__codelineno-9-65 name=__codelineno-9-65 href=#__codelineno-9-65></a><span class=w>  </span><span class=nx>updatedAt</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-9-66><a id=__codelineno-9-66 name=__codelineno-9-66 href=#__codelineno-9-66></a><span class=p>});</span>
</span><span id=__span-9-67><a id=__codelineno-9-67 name=__codelineno-9-67 href=#__codelineno-9-67></a>
</span><span id=__span-9-68><a id=__codelineno-9-68 name=__codelineno-9-68 href=#__codelineno-9-68></a><span class=c1>// Infer types</span>
</span><span id=__span-9-69><a id=__codelineno-9-69 name=__codelineno-9-69 href=#__codelineno-9-69></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>SceneCard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-9-70><a id=__codelineno-9-70 name=__codelineno-9-70 href=#__codelineno-9-70></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>SceneDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span></code></pre></div> <h3 id=performer-schemas>Performer Schemas<a class=headerlink href=#performer-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1>// server/src/schemas/performer.ts</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>z</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>StudioRefSchema</span><span class=p>,</span><span class=w> </span><span class=nx>TagRefSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./refs&#39;</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>PerformerCardSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>  </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>(),</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>  </span><span class=nx>disambiguation</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>  </span><span class=nx>gender</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>  </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>  </span><span class=nx>favorite</span><span class=o>:</span><span class=w> </span><span class=kt>z.boolean</span><span class=p>(),</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>  </span><span class=nx>rating100</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>  </span><span class=nx>sceneCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>  </span><span class=nx>imageCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>  </span><span class=nx>galleryCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>  </span><span class=c1>// User data</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>  </span><span class=nx>userRating</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=w>  </span><span class=nx>isFavorite</span><span class=o>:</span><span class=w> </span><span class=kt>z.boolean</span><span class=p>(),</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=p>});</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>PerformerDetailSchema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PerformerCardSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=w>  </span><span class=nx>birthdate</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a><span class=w>  </span><span class=nx>deathDate</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a><span class=w>  </span><span class=nx>country</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=w>  </span><span class=nx>ethnicity</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>  </span><span class=nx>eyeColor</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=w>  </span><span class=nx>hairColor</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=w>  </span><span class=nx>heightCm</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29 href=#__codelineno-10-29></a><span class=w>  </span><span class=nx>measurements</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30 href=#__codelineno-10-30></a><span class=w>  </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-31><a id=__codelineno-10-31 name=__codelineno-10-31 href=#__codelineno-10-31></a><span class=w>  </span><span class=nx>tattoos</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-32><a id=__codelineno-10-32 name=__codelineno-10-32 href=#__codelineno-10-32></a><span class=w>  </span><span class=nx>piercings</span><span class=o>:</span><span class=w> </span><span class=kt>z.string</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-33><a id=__codelineno-10-33 name=__codelineno-10-33 href=#__codelineno-10-33></a><span class=w>  </span><span class=nx>aliases</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>z</span><span class=p>.</span><span class=kt>string</span><span class=p>()),</span>
</span><span id=__span-10-34><a id=__codelineno-10-34 name=__codelineno-10-34 href=#__codelineno-10-34></a><span class=w>  </span><span class=nx>tags</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>TagRefSchema</span><span class=p>),</span>
</span><span id=__span-10-35><a id=__codelineno-10-35 name=__codelineno-10-35 href=#__codelineno-10-35></a><span class=w>  </span><span class=c1>// Aggregated stats</span>
</span><span id=__span-10-36><a id=__codelineno-10-36 name=__codelineno-10-36 href=#__codelineno-10-36></a><span class=w>  </span><span class=nx>studios</span><span class=o>:</span><span class=w> </span><span class=kt>z.array</span><span class=p>(</span><span class=nx>StudioRefSchema</span><span class=p>.</span><span class=nx>extend</span><span class=p>({</span><span class=w> </span><span class=nx>sceneCount</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>()</span><span class=w> </span><span class=p>})),</span>
</span><span id=__span-10-37><a id=__codelineno-10-37 name=__codelineno-10-37 href=#__codelineno-10-37></a><span class=w>  </span><span class=nx>totalPlayTime</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>(),</span>
</span><span id=__span-10-38><a id=__codelineno-10-38 name=__codelineno-10-38 href=#__codelineno-10-38></a><span class=w>  </span><span class=nx>averageRating</span><span class=o>:</span><span class=w> </span><span class=kt>z.number</span><span class=p>().</span><span class=nx>nullable</span><span class=p>(),</span>
</span><span id=__span-10-39><a id=__codelineno-10-39 name=__codelineno-10-39 href=#__codelineno-10-39></a><span class=p>});</span>
</span><span id=__span-10-40><a id=__codelineno-10-40 name=__codelineno-10-40 href=#__codelineno-10-40></a>
</span><span id=__span-10-41><a id=__codelineno-10-41 name=__codelineno-10-41 href=#__codelineno-10-41></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>PerformerCard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>PerformerCardSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-10-42><a id=__codelineno-10-42 name=__codelineno-10-42 href=#__codelineno-10-42></a><span class=k>export</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=nx>PerformerDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>infer</span><span class=o>&lt;</span><span class=ow>typeof</span><span class=w> </span><span class=nx>PerformerDetailSchema</span><span class=o>&gt;</span><span class=p>;</span>
</span></code></pre></div> <h2 id=migration-strategy>Migration Strategy<a class=headerlink href=#migration-strategy title="Permanent link">&para;</a></h2> <h3 id=approach-incremental-endpoint-by-endpoint>Approach: Incremental, Endpoint by Endpoint<a class=headerlink href=#approach-incremental-endpoint-by-endpoint title="Permanent link">&para;</a></h3> <p>Don't rewrite everything at once. Migrate one endpoint at a time:</p> <ol> <li><strong>Start with a simple endpoint</strong> (e.g., <code>GET /api/tags</code>)</li> <li><strong>Define the schema</strong> for that endpoint's response</li> <li><strong>Add validation</strong> in the controller</li> <li><strong>Update client types</strong> if using shared types</li> <li><strong>Repeat</strong> for next endpoint</li> </ol> <h3 id=example-migration>Example Migration<a class=headerlink href=#example-migration title="Permanent link">&para;</a></h3> <p>Before: <div class="language-typescript highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// controller</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>getScene</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>scene</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>sceneService</span><span class=p>.</span><span class=nx>getById</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>  </span><span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>scene</span><span class=p>);</span><span class=w> </span><span class=c1>// Returns NormalizedScene with 50+ fields</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=p>}</span>
</span></code></pre></div></p> <p>After: <div class="language-typescript highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1>// controller</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../schemas/scene&#39;</span><span class=p>;</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>getScene</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>scene</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>sceneService</span><span class=p>.</span><span class=nx>getById</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>  </span><span class=c1>// Transform to API shape and validate</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=p>.</span><span class=nx>strip</span><span class=p>().</span><span class=nx>parse</span><span class=p>({</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>scene.id</span><span class=p>,</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>    </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>scene.title</span><span class=p>,</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>    </span><span class=c1>// ... explicit mapping</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>    </span><span class=nx>userRating</span><span class=o>:</span><span class=w> </span><span class=kt>scene.userRating</span><span class=p>,</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>    </span><span class=nx>isFavorite</span><span class=o>:</span><span class=w> </span><span class=kt>scene.isFavorite</span><span class=p>,</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>  </span><span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=p>}</span>
</span></code></pre></div></p> <h3 id=helper-transform-functions>Helper: Transform Functions<a class=headerlink href=#helper-transform-functions title="Permanent link">&para;</a></h3> <p>Create transform functions to map DB entities to API shapes:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1>// server/src/transforms/scene.ts</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SceneCard</span><span class=p>,</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../schemas/scene&#39;</span><span class=p>;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrismaScene</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../prisma/types&#39;</span><span class=p>;</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>toSceneCard</span><span class=p>(</span><span class=nx>scene</span><span class=o>:</span><span class=w> </span><span class=kt>PrismaSceneWithRelations</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nx>SceneCard</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>({</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>scene.id</span><span class=p>,</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>    </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=kt>scene.title</span><span class=p>,</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>    </span><span class=nx>date</span><span class=o>:</span><span class=w> </span><span class=kt>scene.date</span><span class=p>,</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>    </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=kt>scene.duration</span><span class=p>,</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>    </span><span class=nx>rating100</span><span class=o>:</span><span class=w> </span><span class=kt>scene.rating100</span><span class=p>,</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>    </span><span class=nx>organized</span><span class=o>:</span><span class=w> </span><span class=kt>scene.organized</span><span class=p>,</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>    </span><span class=nx>pathScreenshot</span><span class=o>:</span><span class=w> </span><span class=kt>scene.pathScreenshot</span><span class=p>,</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=w>    </span><span class=nx>studio</span><span class=o>:</span><span class=w> </span><span class=kt>scene.studio</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>scene.studio.id</span><span class=p>,</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>scene.studio.name</span><span class=p>,</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=w>      </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>scene.studio.imagePath</span><span class=p>,</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>    </span><span class=nx>performers</span><span class=o>:</span><span class=w> </span><span class=kt>scene.performers.map</span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>p.id</span><span class=p>,</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>p.name</span><span class=p>,</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>      </span><span class=nx>imagePath</span><span class=o>:</span><span class=w> </span><span class=kt>p.imagePath</span><span class=p>,</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=w>      </span><span class=nx>gender</span><span class=o>:</span><span class=w> </span><span class=kt>p.gender</span><span class=p>,</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=w>    </span><span class=p>})),</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=w>    </span><span class=nx>tags</span><span class=o>:</span><span class=w> </span><span class=kt>scene.tags.map</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>t.id</span><span class=p>,</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>t.name</span><span class=p>,</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>    </span><span class=p>})),</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=w>    </span><span class=nx>userRating</span><span class=o>:</span><span class=w> </span><span class=kt>scene.userRating?.rating</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=w>    </span><span class=nx>playCount</span><span class=o>:</span><span class=w> </span><span class=kt>scene.playHistory?.length</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=mf>0</span><span class=p>,</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=w>    </span><span class=nx>isFavorite</span><span class=o>:</span><span class=w> </span><span class=kt>scene.favorite?.isFavorite</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=w>    </span><span class=nx>lastPlayedAt</span><span class=o>:</span><span class=w> </span><span class=kt>scene.playHistory?.</span><span class=p>[</span><span class=mf>0</span><span class=p>]</span><span class=o>?</span><span class=p>.</span><span class=nx>playedAt</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=p>}</span>
</span></code></pre></div> <h2 id=endpoint-priority>Endpoint Priority<a class=headerlink href=#endpoint-priority title="Permanent link">&para;</a></h2> <p>Suggested order for migration (high-traffic/high-value first):</p> <ol> <li><code>GET /api/scenes</code> and <code>GET /api/scenes/:id</code></li> <li><code>GET /api/performers</code> and <code>GET /api/performers/:id</code></li> <li><code>GET /api/tags</code> and <code>GET /api/studios</code></li> <li><code>GET /api/galleries</code> and <code>GET /api/images</code></li> <li><code>GET /api/groups</code></li> <li>Playlist endpoints</li> <li>User preference endpoints</li> <li>Stats/dashboard endpoints</li> </ol> <h2 id=testing>Testing<a class=headerlink href=#testing title="Permanent link">&para;</a></h2> <h3 id=unit-tests-for-schemas>Unit Tests for Schemas<a class=headerlink href=#unit-tests-for-schemas title="Permanent link">&para;</a></h3> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../schemas/scene&#39;</span><span class=p>;</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;SceneCardSchema&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;validates a correct scene card&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>      </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Test Scene&#39;</span><span class=p>,</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>      </span><span class=c1>// ... all required fields</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>valid</span><span class=p>)).</span><span class=nx>not</span><span class=p>.</span><span class=nx>toThrow</span><span class=p>();</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;strips extra fields&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>withExtra</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>      </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Test&#39;</span><span class=p>,</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>      </span><span class=c1>// ... required fields</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>      </span><span class=nx>internalField</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;should be removed&#39;</span><span class=p>,</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>strip</span><span class=p>().</span><span class=nx>parse</span><span class=p>(</span><span class=nx>withExtra</span><span class=p>);</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>).</span><span class=nx>not</span><span class=p>.</span><span class=nx>toHaveProperty</span><span class=p>(</span><span class=s1>&#39;internalField&#39;</span><span class=p>);</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;rejects invalid data&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>invalid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>123</span><span class=w> </span><span class=p>};</span><span class=w> </span><span class=c1>// id should be string</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>    </span><span class=nx>expect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>invalid</span><span class=p>)).</span><span class=nx>toThrow</span><span class=p>();</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=p>});</span>
</span></code></pre></div> <h3 id=integration-tests>Integration Tests<a class=headerlink href=#integration-tests title="Permanent link">&para;</a></h3> <p>Verify endpoints return valid shapes:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /api/scenes/:id&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;returns valid SceneDetail shape&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/scenes/123&#39;</span><span class=p>);</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=nx>expect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>)).</span><span class=nx>not</span><span class=p>.</span><span class=nx>toThrow</span><span class=p>();</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=p>});</span>
</span></code></pre></div> <h2 id=dependencies>Dependencies<a class=headerlink href=#dependencies title="Permanent link">&para;</a></h2> <div class="language-json highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=p>{</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=w>  </span><span class=nt>&quot;dependencies&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=nt>&quot;zod&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^3.22.0&quot;</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=p>}</span>
</span></code></pre></div> <p>Zod has no runtime dependencies and is ~50KB minified.</p> <h2 id=success-criteria>Success Criteria<a class=headerlink href=#success-criteria title="Permanent link">&para;</a></h2> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> All API endpoints validated with Zod schemas</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> No <code>NormalizedXxx</code> types extending Stash types</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> TypeScript types derived from Zod schemas (<code>z.infer</code>)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Transform functions for DB → API shape</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Extra fields stripped (no data leakage)</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Existing client functionality unchanged</li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled><span class=task-list-indicator></span></label> Test coverage for all schemas</li> </ul> <h2 id=future-considerations>Future Considerations<a class=headerlink href=#future-considerations title="Permanent link">&para;</a></h2> <h3 id=client-side-validation>Client-Side Validation<a class=headerlink href=#client-side-validation title="Permanent link">&para;</a></h3> <p>Same schemas could be shared with client for request validation:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1>// shared/schemas/api.ts - if using monorepo</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=k>export</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SceneCardSchema</span><span class=p>,</span><span class=w> </span><span class=nx>SceneDetailSchema</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./scene&#39;</span><span class=p>;</span>
</span></code></pre></div> <h3 id=openapi-generation>OpenAPI Generation<a class=headerlink href=#openapi-generation title="Permanent link">&para;</a></h3> <p>Zod schemas can generate OpenAPI specs via <code>zod-to-openapi</code>:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>generateOpenAPI</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;zod-to-openapi&#39;</span><span class=p>;</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=c1>// Auto-generate API documentation from schemas</span>
</span></code></pre></div> <h3 id=error-messages>Error Messages<a class=headerlink href=#error-messages title="Permanent link">&para;</a></h3> <p>Zod provides detailed error messages for debugging:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>  </span><span class=nx>SceneDetailSchema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>z</span><span class=p>.</span><span class=nx>ZodError</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>issues</span><span class=p>);</span><span class=w> </span><span class=c1>// Detailed path + message for each error</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=p>}</span>
</span></code></pre></div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 carrotwaxr </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/carrotwaxr/peek-stash-browser target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://hub.docker.com/r/carrotwaxr/peek-stash-browser target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../javascripts/extra.js></script> </body> </html>