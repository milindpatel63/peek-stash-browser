# v3.1.0 Release Testing Checklist

**Testing Version:** v3.1.0-beta.10
**Previous Stable:** v3.0.0
**Code Review Date:** 2026-01-04

This checklist covers all changes from v3.0.x through v3.1.0 with detailed testing procedures based on comprehensive code review.

---

## Pre-Testing Setup

Before testing, ensure:
1. Fresh database OR upgrade from v3.0.x
2. Stash instance with representative data (mix of scenes, performers, galleries, images)
3. At least one user with admin role
4. Browser dev tools open to monitor network requests

---

## üîí Critical Security (Must Pass Before Release)

### Password Reset Protection

**Issue:** After initial setup completes, the first-time password endpoint must be blocked.

**Test Procedure:**
1. Complete initial setup (create admin user, connect to Stash)
2. Open browser dev tools (Network tab)
3. Send POST request to `/api/auth/first-time-password`:
   ```bash
   curl -X POST http://localhost:9999/api/auth/first-time-password \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","newPassword":"hacked123"}'
   ```
4. **Expected:** 403 Forbidden with message "Setup is complete..."
5. Verify you can still log in with original password

- [ ] Password reset blocked after setup complete (403 response)
- [ ] Original password still works after failed reset attempt

**Code Review Note:** Race condition exists between setup check and password update. Low risk in practice but noted for future hardening.

---

## üöÄ Major Features

### Images Page & Gallery Image Browsing (NEW)

**New Feature:** Dedicated Images browsing page with full filtering capability.

**Test Procedure:**
1. Navigate to Images page from main navigation
2. Verify images load with pagination controls
3. Apply filters: by performer, tag, studio, gallery
4. Test sort options including Random
5. Open an image in lightbox
6. Navigate with arrow keys and verify smooth transitions
7. Wait 3+ seconds on an image, then check Network tab for `recordView` API call

- [ ] Images page loads and displays images correctly
- [ ] Pagination works (change page, change per-page count)
- [ ] Filters apply correctly (performer, tag, studio, gallery)
- [ ] Random sort is deterministic within same session
- [ ] Lightbox opens with keyboard navigation (arrow keys, Escape)
- [ ] View tracking fires after 3 seconds (check Network tab)
- [ ] Swipe gestures work on touch devices

**Known Limitation (from code review):** Cross-page lightbox navigation not yet on standalone Images page (works on GalleryDetail).

### Gallery Image Lightbox

**Test Procedure:**
1. Open a gallery with 50+ images
2. Navigate to last image on current page
3. Press right arrow - should load next page and continue
4. Open metadata drawer (info button or 'i' key)
5. Verify inherited metadata from gallery (studio, photographer, performers, tags)

- [ ] Cross-page navigation works in lightbox
- [ ] Metadata drawer shows inherited fields
- [ ] Fullscreen works (F key or button)
- [ ] Slideshow auto-advances

### Scene URLs Display (#195)
- [ ] Scene detail panel shows URLs field (if present in Stash)
- [ ] Director field displays if present

### Carousel "See More" Links (#192)
- [ ] Home carousels have "See More" button
- [ ] Custom carousels include "See More"
- [ ] See More navigates to correctly filtered scene list
- [ ] Continue Watching carousel has "See More" link

### Proxy Authentication (#224)
- [ ] `PROXY_AUTH_HEADER` environment variable works for reverse proxy auth
- [ ] Normal authentication still functions when not using proxy auth

### Soft-Delete Entities (#232)

**Test Procedure:**
1. Delete a scene in Stash
2. Trigger sync in Peek
3. Check database: scene should have `deletedAt` timestamp set (not removed from DB)
4. Verify scene doesn't appear in browse
5. Re-add same scene in Stash
6. Trigger sync
7. Verify scene reappears in Peek

- [ ] Removed entities are soft-deleted (check DB: deletedAt is set)
- [ ] Soft-deleted items don't appear in browse
- [ ] Re-adding entity in Stash restores it in Peek

---

## üîß Performance & Scalability

### Pre-Computed Exclusions System (#228)

**New Architecture:** Exclusions pre-computed and stored in UserExcludedEntity table.

**Test Procedure:**
1. Hide a performer with many scenes (50+)
2. Navigate to Scenes - verify hidden performer's scenes don't appear
3. Check scene count decreased appropriately
4. Go to admin Server Settings > find exclusion recompute option
5. Trigger recompute
6. Verify scenes still excluded after recompute
7. Unhide the performer
8. Verify scenes reappear immediately (no page refresh needed)

- [ ] Hidden items excluded from all entity lists
- [ ] Cascade exclusions work (hiding studio hides its scenes)
- [ ] Empty entity exclusion works (tags with 0 scenes can be hidden)
- [ ] Exclusion recompute endpoint works
- [ ] Unhiding updates immediately

### Sync Timestamp Handling (#200, #202-#208, #214)

**Bug Fixed:** Infinite re-sync caused by sub-second timestamp precision mismatch with Stash.

**Test Procedure:**
1. Trigger full sync and wait for completion
2. Trigger incremental sync immediately after
3. Check server logs - should show "0 changed" or minimal changes (not re-syncing everything)
4. Edit a scene in Stash (change title)
5. Trigger incremental sync
6. Verify only the changed scene is synced

- [ ] Incremental sync only fetches changed entities
- [ ] No infinite re-sync loops
- [ ] Sync works across timezone differences with Stash
- [ ] Edited entities are picked up by incremental sync

### Scene Tag Inheritance (#227)

**Test Procedure:**
1. Find a performer with tags in Stash (e.g., performer has "Brunette" tag)
2. Find a scene with that performer
3. In Peek, filter scenes by one of the performer's tags ("Brunette")
4. Verify the scene appears in results (inherited tag filtering)

- [ ] Scenes inherit tags from performers/studios/groups
- [ ] Filtering by inherited tags works

### ImageQueryBuilder (#231)
- [ ] Images page loads and filters correctly
- [ ] Gallery images paginate properly
- [ ] Random sort works on images
- [ ] Image exclusions (hidden galleries) work

### Image Gallery Inheritance (#226)
- [ ] Images inherit metadata from parent gallery
- [ ] Gallery performer/tag info shows on images

### Sync Scalability (#220)
**For large libraries (50k+ scenes):**
- [ ] Large libraries sync without timeout
- [ ] Browsing remains responsive after sync

---

## üêõ Bug Fix Verification

### Random Sort Distribution (#203)

**Test Procedure:**
1. Go to Scenes, select Random sort
2. Note the first 5 scene titles
3. Navigate to page 2, then return to page 1
4. Verify same 5 scenes in same order (pagination stable)
5. Refresh the page entirely
6. Verify new random order (different seed on refresh)

- [ ] Random sort is consistent within session
- [ ] Pagination maintains order with same seed
- [ ] Page refresh gives new random order

### Large Exclusion Sets (#204)
- [ ] Works with 10k+ hidden items without SQL error

### Gallery Detail Parity (#215)
- [ ] Gallery lightbox shows performer/tag info
- [ ] Image metadata matches gallery view

### Playlist User Data (#217)

**Bug Fixed:** Playlist was showing Stash ratings instead of Peek ratings.

**Test Procedure:**
1. Rate a scene 5 stars in Peek
2. Ensure same scene has different (or no) rating in Stash
3. Add scene to a playlist in Peek
4. View playlist - verify Peek's 5-star rating shows

- [ ] Playlist shows Peek ratings, not Stash ratings
- [ ] Playlist shows Peek favorite status, not Stash

### Chunked Image Queries (#222)
- [ ] Large galleries (1000+ images) load correctly
- [ ] Cross-page lightbox navigation works

### Request Cancellation (#213)

**Test Procedure:**
1. Open Scenes page
2. Type in search box rapidly (a, ab, abc, abcd)
3. Watch Network tab - previous requests should be cancelled (red in dev tools)
4. Only final search result should populate

- [ ] Previous requests cancelled when new search starts
- [ ] No stale data from cancelled requests

---

## üé® UI Improvements

### Detail Page Image Tabs (#216)
- [ ] Performer/Studio/Tag detail pages show image counts
- [ ] Image counts include inherited images

### Playlist/Watch History Previews (#219)
- [ ] Playlist items show animated preview on hover
- [ ] Watch history items show animated preview on hover

---

## üìù Documentation & Developer Experience

### API Documentation Generator (#237)
```bash
cd server && npm run generate-api-docs
```
- [ ] Command runs without error
- [ ] Generated docs appear in docs/development/api-reference/

### API Types (#234-236)
```bash
cd server && npm run build
```
- [ ] TypeScript build succeeds with no type errors

---

## üîÑ Database Migration

### Auto-Sync After Migration (#233)
- [ ] Fresh install triggers full sync automatically
- [ ] Upgrading from 3.0.x triggers sync for new fields

---

## üìã Regression Tests

### Core Functionality
- [ ] Login/logout works
- [ ] Scene browsing and filtering
- [ ] Performer/Studio/Tag/Group/Gallery browsing
- [ ] Scene playback (direct and transcoded)
- [ ] Playlists CRUD
- [ ] Custom carousels CRUD
- [ ] Rating and favoriting entities
- [ ] Watch history tracking
- [ ] Image viewing and O-counter

### Search & Filters
- [ ] Text search
- [ ] Performer filter
- [ ] Studio filter
- [ ] Tag filter (including inherited)
- [ ] Date filters
- [ ] Duration filters
- [ ] Resolution filters
- [ ] Sort options (including random)

### Settings
- [ ] User settings save/load
- [ ] Server settings (admin only)
- [ ] Custom themes

---

## üß™ Automated Test Verification

### Unit Tests
```bash
cd server && npm run test:run
```
- [ ] All unit tests pass (500+ tests)
- [ ] Integration tests may skip (expected - need running server)

### Integration Tests (Optional - requires server)
```bash
cd server && npm run test:integration
```
**Requires:** Running Peek server at localhost:9999 with test data
- [ ] API integration tests pass
- [ ] Filter integration tests pass

### Linting
```bash
cd server && npm run lint
cd client && npm run lint
```
- [ ] Server lint passes (warnings OK for any types)
- [ ] Client lint passes (warnings OK for exhaustive-deps)

---

## üîç Code Review Findings Summary

### Critical Issues: None

### Important Issues (Should address in 3.1.x patch)
1. **SQL Injection Risk in ExclusionComputationService** - `Prisma.raw()` with tag IDs (low risk, IDs from DB not user input)
2. **SceneTagInheritanceService uses $executeRawUnsafe** - Scene IDs interpolated, recommend parameterized queries
3. **Missing indexes** - ImagePerformer.imageId and ImageTag.imageId lack indexes for hydration queries
4. **Setup reset endpoint** - `/api/setup/reset` is public and could be exploited on single-user systems

### Suggestions (Address in 3.2.0)
1. Save intermediate sync progress for crash recovery
2. Add rate limiting to security-sensitive endpoints
3. Implement cross-page lightbox on Images page
4. Add audit logging for password changes
5. Increase bcrypt cost factor from 10 to 12

---

## üìö Documentation Gaps

~~These need to be created/updated before stable release:~~

All documentation gaps have been addressed in PR #240:

1. ‚úÖ **Images Page User Guide** - Created `docs/user-guide/images.md`
2. ‚úÖ **Recommendations Feature** - Created `docs/user-guide/recommendations.md`
3. ‚úÖ **Scene URLs Feature** - Documented in release notes
4. ‚úÖ **CHANGELOG/Release Notes** - Created `docs/releases/v3.1.0.md`

---

## üîß Test Infrastructure Issue

~~**Issue Identified:** Default `npm test` picks up integration tests that fail without running server.~~

‚úÖ **Fixed in PR #248** - All test infrastructure issues resolved:

- ‚úÖ `vitest.config.ts` updated to exclude integration tests from default run
- ‚úÖ `StashSyncService.integration.test.ts` renamed to `.stash.test.ts`
- ‚úÖ `SceneQueryBuilder.integration.test.ts` moved to `integration/` folder

---

## üéØ UI Testing (Puppeteer/Playwright) Assessment

**Would E2E tests be beneficial?** Yes, but significant initial lift.

**Priority features for E2E testing:**
1. Video playback flow (start, pause, resume, quality switch)
2. Lightbox navigation (keyboard, touch, cross-page)
3. Filter application and results verification
4. Login/logout authentication flow

**Estimated effort:** 2-3 dedicated sessions to set up infrastructure, then incremental test additions.

---

## Environment Notes

**Test Environment:**
- Platform: ___
- Stash Version: ___
- Library Size: ___ scenes, ___ images, ___ performers
- Browser: ___

**Issues Found During Testing:**


---

## Sign-Off

- [ ] All Critical Security items pass
- [ ] All Major Feature items pass
- [ ] No regression in core functionality
- [ ] Documentation gaps addressed
- [ ] Ready for stable v3.1.0 release

**Tested by:** ___
**Date:** ___
