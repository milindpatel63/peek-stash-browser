# v3.1.0 Release Notes

**Release Date:** January 2026

This release introduces major new features including Images browsing, personalized Recommendations, and significant performance and security improvements.

---

## New Features

### Images Page

Browse, filter, and view all images in your Stash library with a dedicated Images page:

- **Full filtering** - Filter by performer, studio, tag, or gallery
- **Lightbox viewer** - View images in full-screen with keyboard navigation
- **Cross-page navigation** - Navigate seamlessly across pagination in the lightbox
- **Slideshow mode** - Automatic advancement with configurable timing
- **Rating & favorites** - Rate images directly in the lightbox
- **O counter** - Track special moments, syncs with Stash
- **View tracking** - Automatic view count after 3+ seconds

See the [Images User Guide](../user-guide/images.md) for details.

### Personalized Recommendations

Get scene suggestions based on your favorites and ratings:

- **Smart matching** - Recommends scenes based on favorited/rated performers, studios, and tags
- **Empty state guidance** - When no recommendations are available, explains what activity is needed
- **Recommended sidebar** - Related suggestions while viewing scenes

See the [Recommendations User Guide](../user-guide/recommendations.md) for details.

### Scene URLs & Director Display

Scene detail pages now show:

- **External URLs** - Links to scene sources (when available in Stash)
- **Director** - Director information displayed prominently

### Carousel "See More" Links

Homepage carousels now include "See More" buttons:

- Navigate to filtered scene lists with one click
- Works for all carousel types including custom carousels
- Continue Watching carousel includes "See More"

### Soft-Delete Entities

Entities removed from Stash are now soft-deleted in Peek:

- Scenes/performers/etc. marked with `deletedAt` instead of hard delete
- Re-adding in Stash automatically restores them in Peek
- Preserves your ratings and watch history

---

## Performance Improvements

### Pre-Computed Exclusions

Complete redesign of the exclusion system for better performance:

- Hidden items pre-computed and cached in `UserExcludedEntity` table
- Cascade exclusions (hiding a studio hides all its scenes) computed efficiently
- Dramatic improvement for users with many hidden items
- Works correctly with 10,000+ exclusions

### Scene Tag Inheritance

Scenes now inherit tags from performers, studios, and groups:

- Filter by performer tags to find related scenes
- Tag information denormalized for fast queries
- Inheritance computed during sync

### Database Indexes

New indexes for faster image queries:

- `ImagePerformer.imageId` - Faster performer-to-image lookups
- `ImageTag.imageId` - Faster tag-to-image lookups

---

## Bug Fixes

### Sync Timestamp Handling

Fixed infinite re-sync issues caused by timestamp precision mismatches:

- Sub-second precision now handled correctly
- Timezone differences with Stash resolved
- Incremental sync only fetches changed entities

### Random Sort Distribution

Fixed random sort producing sequential IDs:

- Proper shuffling algorithm implementation
- Consistent pagination with same seed within session
- New random order on page refresh

### Playlist User Data

Fixed playlist showing Stash ratings instead of Peek ratings:

- Playlist items now correctly display your Peek ratings
- Favorite status matches Peek, not Stash

### Request Cancellation

Improved request handling for rapid filtering:

- Previous requests cancelled when new search starts
- No stale data from cancelled requests
- Better performance during rapid filter changes

---

## Security Improvements

### Setup Endpoint Protection

The `/api/setup/reset` endpoint now requires confirmation:

- Must send `{ confirm: "RESET_SETUP" }` to confirm
- Prevents accidental or malicious resets
- Existing guards (incomplete setup, single user) still apply

---

## Infrastructure

### Integration Testing

New integration test infrastructure:

- Dedicated `integration/` folder for true integration tests
- Separate `npm run test:integration` command
- Default `npm test` runs only unit tests (faster CI)

### API Documentation Generator

New tooling for API documentation:

```bash
npm run generate-api-docs
```

Generates documentation from route definitions.

---

## Upgrading

### From v3.0.x

1. Stop Peek server
2. Pull new Docker image or update source
3. Start server - migrations run automatically
4. Full sync triggered to populate new fields

### Database Migration

Automatic migrations include:

- `UserExcludedEntity` table for pre-computed exclusions
- `inheritedTagIds` field on scenes
- Image junction table indexes

---

## Breaking Changes

None. v3.1.0 is fully backwards compatible with v3.0.x.

---

## Known Issues

- Large library initial sync may take several minutes
