# Peek v3.0.0 Release Evaluation

**Date:** December 15, 2025
**Evaluator:** Claude Code (AI-assisted)
**Version Evaluated:** v3.0.0-beta.9

---

## Executive Summary

Peek v3.0.0 represents a **major architectural change** from in-memory caching to SQLite-based entity storage. After 9 beta versions, the release is **conditionally ready** for production with the following considerations:

| Area | Status | Notes |
|------|--------|-------|
| Database Migrations | **Ready** | Clean upgrade paths from 1.x and 2.x verified |
| Core Functionality | **Ready** | Major bugs addressed across beta cycle |
| Filtering/Sorting | **Stable** | 13 fixes in beta cycle, now comprehensive |
| Security | **Review Needed** | Non-blocking issues identified |
| Documentation | **Needs Update** | Outdated references to beta.2 |

**Recommendation:** Proceed with 3.0.0 release after updating documentation and noting user action items.

---

## 1. Database Migration Analysis

### Migration Chain (7 migrations)

| # | Migration | Description | Added In |
|---|-----------|-------------|----------|
| 1 | `0_baseline` | Core user tables (User, WatchHistory, Playlist, Ratings, etc.) | v2.0.0 |
| 2 | `20251126202944_add_user_carousel` | UserCarousel table | v2.1.0 |
| 3 | `20251211000000_stash_entities` | StashScene, StashPerformer, junction tables (23 new tables) | v3.0.0-beta.1 |
| 4 | `20251211100000_entity_counts` | Count columns on Stash* tables | v3.0.0-beta.1 |
| 5 | `20251214000000_add_unit_preference` | User.unitPreference column | v3.0.0-beta.5 |
| 6 | `20251214100000_gallery_file_basename` | StashGallery.fileBasename | v3.0.0-beta.6 |
| 7 | `20251215000000_add_performer_fake_tits` | StashPerformer.fakeTits | v3.0.0-beta.9 |

### Upgrade Path Verification

| Source Version | Migration Handling | Status |
|----------------|-------------------|--------|
| **v1.x (pre-migration)** | schemaCatchup creates missing tables, marks baseline+carousel applied | **Verified** |
| **v2.0.x** | schemaCatchup handles broken states, Prisma applies remaining | **Verified** |
| **v2.1.x** | Prisma applies migrations 3-7 | **Verified** |
| **v3.0.0-beta.1-4** | Prisma applies migrations 4-7 | **Verified** |
| **v3.0.0-beta.5-8** | Prisma applies migrations 5-7 | **Verified** |
| **v3.0.0-beta.9** | No migrations needed | **Verified** |
| **Fresh install** | All 7 migrations applied | **Verified** |

### Data Preservation

User data is **fully preserved** during upgrade:
- User accounts and passwords
- Watch history and resume positions
- Playlists and playlist items
- All ratings and favorites (Scene, Performer, Studio, Tag, Gallery, Group, Image)
- Filter presets and carousel preferences
- Content restrictions and hidden entities
- Custom themes

### Potential Migration Issues

**None identified.** The schemaCatchup.ts module handles all legacy database scenarios correctly.

---

## 2. Breaking Changes (v2.x to v3.0)

### Architectural Changes

1. **In-Memory Cache → SQLite Tables**
   - Entity data now persisted in SQLite
   - Initial sync required after upgrade
   - Subsequent syncs are incremental

2. **Environment Variables**
   - `STASH_URL` and `STASH_API_KEY` no longer needed as env vars
   - Connection configured via Setup Wizard, stored in database

### Removed Features

1. **Local Transcoding** (removed in v2.0)
   - Peek now proxies streams directly through Stash
   - No more FFmpeg dependency for streaming

2. **Path Mappings** (removed in v2.0)
   - No longer needed since streaming proxies through Stash

### New Features Requiring User Action

| Feature | User Action |
|---------|-------------|
| Unit Preference | Optional: Set metric/imperial in Settings |
| Full Sync Post-Beta | **Recommended**: Run full sync to populate new fields (fileBasename, fakeTits) |

---

## 3. Beta Fix Analysis

### Fix Distribution by Beta Version

| Version | Fix Count | Primary Focus |
|---------|-----------|---------------|
| beta.1 → beta.2 | 1 | Permissions |
| beta.2 → beta.3 | 0 | - |
| beta.3 → beta.4 | 5 | Filter data loading |
| beta.4 → beta.5 | 13 | Sorting/filtering (major) |
| beta.5 → beta.6 | 6 | UI, watch history, settings |
| beta.6 → beta.7 | 1 | O counter aggregation |
| beta.7 → beta.8 | 1 | Performer filter parsing |
| beta.8 → beta.9 | 1 | Case sensitivity, new field |

### Recurring Issue Patterns

1. **Performer Filters** (4 fix iterations)
   - Initial data loading issues
   - Career length parsing complexity
   - Case sensitivity
   - Missing fields (fakeTits)

2. **Sorting Implementation** (8 fixes in beta.5)
   - Missing sort options
   - Wrong SQL column names
   - Rating field confusion (Stash vs user)

3. **Schema/Migration Mismatches** (3 fixes)
   - unitPreference migration missing
   - fakeTits field sync

### Risk Assessment

| Area | Risk Level | Notes |
|------|------------|-------|
| Performer Filters | LOW | Comprehensive overhaul completed in beta.5, edge cases addressed in beta.8-9 |
| Sorting | LOW | All 8 issues fixed in beta.5 |
| Watch History | LOW | Event timing fixed in beta.5-6 |
| Gallery Display | LOW | fileBasename fallback added |

---

## 4. Core System Stability

### StashSyncService - STABLE with notes

**Strengths:**
- Proper abort handling for cancellable syncs
- Entity ID validation for SQL injection defense
- Progress events for UI feedback
- Soft-delete preserves data

**Areas for Future Improvement (non-blocking):**
- Transaction wrapping for atomic sync operations
- Consider parameterized queries for additional safety

### SceneQueryBuilder - STABLE

**Strengths:**
- Parameterized SQL queries throughout
- Efficient exclusion filter handling
- Count query optimization
- Proper hierarchy expansion

**Minor Notes:**
- Exclusion sets >500 items are truncated with warning (documented behavior)

### Database Initialization - STABLE

**Strengths:**
- Comprehensive legacy database handling
- Idempotent schema catchup
- Clear migration flow

### Authentication - STABLE

**Strengths:**
- HTTP-only cookies prevent XSS
- bcrypt password hashing
- Role-based access control

**Future Improvements (non-blocking):**
- Rate limiting on login endpoint
- Token revocation on logout

---

## 5. Issues Categorized by Priority

### BLOCKERS (must fix before release)

**None identified.**

### SHOULD-FIX (recommended before release)

| Issue | Description | Effort |
|-------|-------------|--------|
| Documentation Outdated | upgrading.md references beta.2, needs update to beta.9/3.0.0 | Low |
| docs/index.md Outdated | References transcoding, default credentials | Low |
| README Beta Banner | Remove beta warning for stable release | Low |

### NICE-TO-HAVE (can be addressed post-release)

| Issue | Description | Priority |
|-------|-------------|----------|
| Rate Limiting | Add to login endpoint | Medium |
| Token Revocation | Implement logout blacklist | Medium |
| Query Timeout | Add timeout for complex queries | Low |

---

## 6. User Action Items for v3.0.0

### All Users

1. **Back up database** before upgrading
2. **Wait for initial sync** after upgrade (varies by library size)

### Users Upgrading from 3.0.0-beta.x

1. **Run full sync** via Settings → Sync to populate new fields:
   - `fileBasename` for gallery display (beta.6+)
   - `fakeTits` for performer filters (beta.9+)

### Users Upgrading from 2.x

No special action needed beyond backup and sync wait.

### Users Upgrading from 1.x

No special action needed beyond backup and sync wait. schemaCatchup handles legacy databases automatically.

---

## 7. Recommended Documentation Updates

### Files to Update

1. **README.md**
   - Remove beta warning banner
   - Update version references

2. **docs/getting-started/upgrading.md**
   - Update "Latest" from beta.2 to 3.0.0
   - Add beta.x → 3.0.0 upgrade notes
   - Add full sync recommendation for beta upgraders

3. **docs/index.md**
   - Remove transcoding references
   - Remove default credentials section (Setup Wizard now handles)

4. **CLAUDE.md**
   - Update release status if needed

---

## 8. Release Checklist

- [ ] Update README.md (remove beta banner)
- [ ] Update docs/getting-started/upgrading.md (comprehensive update)
- [ ] Update docs/index.md (remove outdated info)
- [ ] Verify all tests pass
- [ ] Verify lint passes
- [ ] Tag v3.0.0
- [ ] Create GitHub release with release notes
- [ ] Update Docker Hub description
- [ ] Post to Discourse/Discord

---

## Appendix: Version History

### v3.0.0 Beta Timeline

| Version | Date | Key Changes |
|---------|------|-------------|
| beta.1 | Dec 10 | Initial SQLite entity cache |
| beta.2 | Dec 10 | Tag visibility fix |
| beta.3 | Dec 12 | Video player improvements |
| beta.4 | Dec 12 | Filter data loading fixes |
| beta.5 | Dec 12 | Major sorting/filtering overhaul |
| beta.6 | Dec 14 | UI fixes, watch history, unit preference |
| beta.7 | Dec 14 | O counter aggregation fix |
| beta.8 | Dec 14 | Performer filter parsing |
| beta.9 | Dec 15 | Case sensitivity, fakeTits field |

### Breaking Changes by Major Version

| Version | Breaking Changes |
|---------|-----------------|
| v1.x → v2.0 | Removed local transcoding, removed path mappings |
| v2.x → v3.0 | Architecture change (memory → SQLite), initial sync required |
