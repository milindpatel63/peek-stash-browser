# 3.0 Polish - Design Document

Three minor issues to address before the 3.0 release.

## Issue 1: Long Filename Overflow on Scene Cards

**Problem:** Filenames like `OnlyTarts.25.09.12.Isabella.De.Laa.Big.Wave.In.Her.Pussy.XXX.1080p.MP4-WRB[XC]` are unbroken strings that overflow the card boundaries because CSS doesn't know where to break them.

**Solution:** Add `word-break: break-all` to the title element in `CardComponents.jsx`. This forces breaks anywhere in long strings, allowing the existing line-clamp and ellipsis to work correctly.

**File:** `client/src/components/ui/CardComponents.jsx` (CardTitle component, around line 310)

## Issue 2: Text Search Fields

**Problem:** Peek's text search doesn't match Stash's behavior. Stash searches more fields.

**Current state:**
- Scenes: `title`, `details`
- Performers: `name`, `details`
- Studios: `name`, `details`
- Tags: `name`

**Stash searches:**
- Scenes: `title`, `details`, `filepath`, `fingerprint`, `marker titles`
- Performers: `name`, `aliases`
- Studios: `name`, `aliases`
- Tags: `name`, `aliases`, `sort_name`

**Solution:**
- Scenes: Add `filepath` to search (requires SQL change in SceneQueryBuilder)
- Performers: Add `aliases` (keep `details`)
- Studios: Add `aliases` (keep `details`)
- Tags: Add `aliases`

**Files:**
- `server/services/SceneQueryBuilder.ts` - Add filepath to SQL LIKE query
- `server/controllers/library/performers.ts` - Add aliases to filter
- `server/controllers/library/studios.ts` - Add aliases to filter
- `server/controllers/library/tags.ts` - Add aliases to filter

## Issue 3: Last Sync Time Not Updated for Incremental Syncs

**Problem:** The Server Settings page shows "Last synced" time, but it only reflects full syncs, not incremental/periodic syncs.

**Root cause:** In `StashEntityService.getLastRefreshed()`:
```typescript
const syncState = await prisma.syncState.findFirst({
  where: { entityType: "scene" },
  orderBy: { lastFullSync: "desc" },  // Only orders by full sync
});
return syncState?.lastFullSync || syncState?.lastIncrementalSync || null;
```

The query orders by `lastFullSync` only, so if incremental syncs happen after a full sync, they're not reflected.

**Solution:** Return whichever is more recent between `lastFullSync` and `lastIncrementalSync`. Compare both timestamps and return the later one.

**File:** `server/services/StashEntityService.ts` (around line 1208)
