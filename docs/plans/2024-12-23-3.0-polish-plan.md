# 3.0 Polish Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix three minor issues for the Peek 3.0 release: long filename overflow, text search fields (fixes #196), and last sync time display.

**Architecture:** Small, targeted changes to existing components. No new files or major refactoring needed.

**Tech Stack:** React (client), TypeScript/Express (server), SQLite via Prisma (database)

---

## Task 1: Fix Long Filename Overflow in CardTitle

**Files:**
- Modify: `client/src/components/ui/CardComponents.jsx:308-322`

**Step 1: Add word-break to title element**

In the `CardTitle` component, add `wordBreak: "break-all"` to the title `<h3>` style object.

```jsx
const titleElement = (
  <h3
    className="font-semibold leading-tight text-center"
    style={{
      color: "var(--text-primary)",
      height: titleHeight,
      display: "-webkit-box",
      WebkitLineClamp: maxTitleLines,
      WebkitBoxOrient: "vertical",
      overflow: "hidden",
      textOverflow: "ellipsis",
      wordBreak: "break-all",  // ADD THIS LINE
    }}
  >
    {title}
  </h3>
);
```

**Step 2: Verify visually**

Run: `cd client && npm run dev`

Test by viewing a scene card with a long unbroken filename like "OnlyTarts.25.09.12.Isabella.De.Laa.Big.Wave.In.Her.Pussy.XXX.1080p.MP4-WRB". The title should wrap and truncate with ellipsis instead of overflowing.

**Step 3: Commit**

```bash
git add client/src/components/ui/CardComponents.jsx
git commit -m "fix: prevent long filename overflow in scene cards"
```

---

## Task 2: Add Filepath to Scene Text Search (Fixes #196)

**Files:**
- Modify: `server/controllers/library/scenes.ts:1048-1065` (first occurrence)
- Modify: `server/controllers/library/scenes.ts:1105-1122` (second occurrence)

**Step 1: Add filePath to first search filter (lines 1048-1065)**

Find the scene text search filter around line 1048 and add `filePath` to the search:

```typescript
if (searchQuery) {
  const lowerQuery = searchQuery.toLowerCase();
  scenes = scenes.filter((s) => {
    const title = s.title || "";
    const details = s.details || "";
    const filePath = s.files?.[0]?.path || "";  // ADD THIS LINE
    const performers = (s.performers || [])
      .map((p) => p.name || "")
      .join(" ");
    const studio = s.studio?.name || "";
    const tags = (s.tags || []).map((t) => t.name || "").join(" ");

    return (
      title.toLowerCase().includes(lowerQuery) ||
      details.toLowerCase().includes(lowerQuery) ||
      filePath.toLowerCase().includes(lowerQuery) ||  // ADD THIS LINE
      performers.toLowerCase().includes(lowerQuery) ||
      studio.toLowerCase().includes(lowerQuery) ||
      tags.toLowerCase().includes(lowerQuery)
    );
  });
}
```

**Step 2: Add filePath to second search filter (lines 1105-1122)**

Find the second occurrence around line 1105 and make the same change:

```typescript
if (searchQuery) {
  const lowerQuery = searchQuery.toLowerCase();
  scenes = scenes.filter((s) => {
    const title = s.title || "";
    const details = s.details || "";
    const filePath = s.files?.[0]?.path || "";  // ADD THIS LINE
    const performers = (s.performers || [])
      .map((p) => p.name || "")
      .join(" ");
    const studio = s.studio?.name || "";
    const tags = (s.tags || []).map((t) => t.name || "").join(" ");

    return (
      title.toLowerCase().includes(lowerQuery) ||
      details.toLowerCase().includes(lowerQuery) ||
      filePath.toLowerCase().includes(lowerQuery) ||  // ADD THIS LINE
      performers.toLowerCase().includes(lowerQuery) ||
      studio.toLowerCase().includes(lowerQuery) ||
      tags.toLowerCase().includes(lowerQuery)
    );
  });
}
```

**Step 3: Run lint to check for errors**

Run: `cd server && npm run lint`

Expected: No errors

**Step 4: Commit**

```bash
git add server/controllers/library/scenes.ts
git commit -m "fix: include filepath in scene text search

Closes #196"
```

---

## Task 3: Add Aliases to Tag Text Search

**Files:**
- Modify: `server/controllers/library/tags.ts:284-292` (first occurrence)
- Modify: `server/controllers/library/tags.ts:877-885` (second occurrence)

**Step 1: Add aliases to first search filter (lines 284-292)**

Find the tag text search filter around line 284 and add `aliases`:

```typescript
if (searchQuery) {
  const lowerQuery = searchQuery.toLowerCase();
  tags = tags.filter((t) => {
    const name = t.name || "";
    const description = t.description || "";
    const aliases = (t.aliases || []).join(" ");  // ADD THIS LINE
    return (
      name.toLowerCase().includes(lowerQuery) ||
      description.toLowerCase().includes(lowerQuery) ||
      aliases.toLowerCase().includes(lowerQuery)  // ADD THIS LINE
    );
  });
}
```

**Step 2: Add aliases to second search filter (lines 877-885)**

Find the second occurrence around line 877 and make the same change:

```typescript
if (searchQuery) {
  const lowerQuery = searchQuery.toLowerCase();
  tags = tags.filter((t) => {
    const name = t.name || "";
    const description = t.description || "";
    const aliases = (t.aliases || []).join(" ");  // ADD THIS LINE
    return (
      name.toLowerCase().includes(lowerQuery) ||
      description.toLowerCase().includes(lowerQuery) ||
      aliases.toLowerCase().includes(lowerQuery)  // ADD THIS LINE
    );
  });
}
```

**Step 3: Run lint to check for errors**

Run: `cd server && npm run lint`

Expected: No errors

**Step 4: Commit**

```bash
git add server/controllers/library/tags.ts
git commit -m "fix: include aliases in tag text search"
```

---

## Task 4: Add Aliases to Studio Text Search

**Files:**
- Modify: `server/controllers/library/studios.ts:169-178` (first occurrence)
- Modify: `server/controllers/library/studios.ts:528+` (second occurrence - findStudiosSimple)

**Note:** Studios have an `aliases` field in Stash but Peek doesn't currently sync it. Check if the field exists on NormalizedStudio before adding. If not available, skip this task.

**Step 1: Check if aliases field exists**

Search for `aliases` in the studio type or data. If NormalizedStudio doesn't have aliases, this task should be skipped - adding it would require a schema migration and sync changes which is out of scope for this polish release.

**Step 2: If aliases exists, add to first search filter (lines 169-178)**

```typescript
if (searchQuery) {
  const lowerQuery = searchQuery.toLowerCase();
  studios = studios.filter((s) => {
    const name = s.name || "";
    const details = s.details || "";
    const aliases = (s.aliases || []).join(" ");  // ADD IF FIELD EXISTS
    return (
      name.toLowerCase().includes(lowerQuery) ||
      details.toLowerCase().includes(lowerQuery) ||
      aliases.toLowerCase().includes(lowerQuery)  // ADD IF FIELD EXISTS
    );
  });
}
```

**Step 3: If aliases exists, add to second search filter**

Apply same change to the second occurrence.

**Step 4: Run lint and commit (if changes made)**

```bash
git add server/controllers/library/studios.ts
git commit -m "fix: include aliases in studio text search"
```

---

## Task 5: Fix Last Sync Time to Show Most Recent Sync

**Files:**
- Modify: `server/services/StashEntityService.ts:1208-1215`

**Step 1: Update getLastRefreshed to return most recent sync**

Replace the current `getLastRefreshed()` implementation:

```typescript
/**
 * Get last refresh time
 */
async getLastRefreshed(): Promise<Date | null> {
  const syncState = await prisma.syncState.findFirst({
    where: { entityType: "scene" },
  });

  if (!syncState) return null;

  const { lastFullSync, lastIncrementalSync } = syncState;

  // Return whichever sync happened more recently
  if (!lastFullSync) return lastIncrementalSync;
  if (!lastIncrementalSync) return lastFullSync;

  return lastFullSync > lastIncrementalSync ? lastFullSync : lastIncrementalSync;
}
```

**Step 2: Run tests**

Run: `cd server && npm test -- --grep "getLastRefreshed"`

If there are existing tests for this function, they may need updating.

**Step 3: Run lint**

Run: `cd server && npm run lint`

Expected: No errors

**Step 4: Commit**

```bash
git add server/services/StashEntityService.ts
git commit -m "fix: show most recent sync time (full or incremental)"
```

---

## Task 6: Run Full Test Suite and Verify

**Step 1: Run server tests**

Run: `cd server && npm test`

Expected: All tests pass

**Step 2: Run client lint**

Run: `cd client && npm run lint`

Expected: No errors

**Step 3: Build both client and server**

Run: `cd client && npm run build && cd ../server && npm run build`

Expected: Both build successfully

**Step 4: Manual verification**

Start the app and verify:
1. Long filenames on scene cards wrap and truncate properly
2. Searching for a filename substring returns matching scenes
3. Searching for tag aliases returns matching tags
4. Server Settings page shows the correct last sync time after an incremental sync

---

## Summary

| Task | Description | Files Modified |
|------|-------------|----------------|
| 1 | Fix filename overflow | `client/src/components/ui/CardComponents.jsx` |
| 2 | Add filepath to scene search (#196) | `server/controllers/library/scenes.ts` |
| 3 | Add aliases to tag search | `server/controllers/library/tags.ts` |
| 4 | Add aliases to studio search | `server/controllers/library/studios.ts` (if field exists) |
| 5 | Fix last sync time display | `server/services/StashEntityService.ts` |
| 6 | Verify all changes | N/A |
